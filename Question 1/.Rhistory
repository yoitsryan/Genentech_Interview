)
)
# Finally, DSSTDY should be the number of days that pass from the first recorded
# date for each individual USUBJID.
ds <- ds %>%
mutate(DSDTC = as.Date(DSDTC, format = "%d-%m-%Y")) %>%     # ensure Date type
group_by(USUBJID) %>%
mutate(
DSSTDY = as.numeric(DSDTC - min(DSDTC, na.rm = TRUE))
) %>%
ungroup()
View(ds)
ds = ds_raw %>%
# There are 6 columns already present in the raw data that simply need renaming
rename(
STUDYID = STUDY,
USUBJID = PATNUM,
DSTERM = IT.DSTERM,
VISIT = INSTANCE,
DSDTC = DSDTCOL,
DSSTDTC = IT.DSSTDAT
) %>%
# The DOMAIN is DS (disposition)
mutate(DOMAIN = "DS") %>%
# We need unique identifiers for each record in the dataset (DSSEQ)
mutate(DSSEQ = paste0("R", row_number()))
# The values for DSDECOD are listed in either one column or the other.
ds$DSDECOD = coalesce(ds$IT.DSDECOD, ds$OTHERSP)
# The category should either be Protocol Milestone or Disposition Event.
# Randomization and informed consent are the only two protocol milestones that exist.
# Informed consent is not listed in the dataset anywhere.
ds$DSCAT <- ifelse(ds$DSDECOD == "Randomized",
"Protocol Milestone",
"Disposition Event")
# I included people who had Screen Failures. They are going to have visit numbers of 0.1
# For unscheduled visits, the visit number will have a decimal after it.
# Set VISITNUM's for each visit
ds <- ds %>%
mutate(
VISITNUM = case_when(
DSDECOD == "Randomized" ~ 1,
DSDECOD == "Completed" ~ 2,
DSDECOD == "Final Lab Visit" ~ 3,
DSDECOD == "Final Retrieval Visit" ~ 4,
DSDECOD == "Screen Failure" ~ 0.1,
TRUE ~ 1.1
)
)
# Finally, DSSTDY should be the number of days that pass from the first recorded
# date for each individual USUBJID.
ds <- ds %>%
mutate(DSDTC = as.Date(DSDTC, format = "%m-%d-%Y")) %>%     # ensure Date type
group_by(USUBJID) %>%
mutate(
DSSTDY = as.numeric(DSDTC - min(DSDTC, na.rm = TRUE))
) %>%
ungroup()
View(ds)
ds <- ds[, c("STUDYID", "DOMAIN", "USUBJID", "DSSEQ", "DSTERM",
"DSDECOD", "DSCAT", "VISITNUM", "VISIT",
"DSDTC", "DSSTDTC", "DSSTDY")]
View(ds)
ds <- ds %>%
mutate(DSDTC = format(DSDTC, "%m-%d-%Y"))
View(ds)
library(admiral)
library(dplyr, warn.conflicts = FALSE)
library(pharmaversesdtm)
library(lubridate)
library(stringr)
dm <- pharmaversesdtm::dm
ds <- pharmaversesdtm::ds
ex <- pharmaversesdtm::ex
ae <- pharmaversesdtm::ae
lb <- pharmaversesdtm::lb
dm <- convert_blanks_to_na(dm)
ds <- convert_blanks_to_na(ds)
ex <- convert_blanks_to_na(ex)
ae <- convert_blanks_to_na(ae)
lb <- convert_blanks_to_na(lb)
ds_raw = pharmaverseraw::ds_raw
study_ct = read.csv("sdtm_ct.csv")
# I have never worked with SDTM data before, so bear with me here
# We need 12 variables in our cleaned dataset
ds = ds_raw %>%
# There are 6 columns already present in the raw data that simply need renaming
rename(
STUDYID = STUDY,
USUBJID = PATNUM,
DSTERM = IT.DSTERM,
VISIT = INSTANCE,
DSDTC = DSDTCOL,
DSSTDTC = IT.DSSTDAT
) %>%
# The DOMAIN is DS (disposition)
mutate(DOMAIN = "DS") %>%
# We need unique identifiers for each record in the dataset (DSSEQ)
mutate(DSSEQ = paste0("R", row_number()))
# The values for DSDECOD are listed in either one column or the other.
ds$DSDECOD = coalesce(ds$IT.DSDECOD, ds$OTHERSP)
# The category should either be Protocol Milestone or Disposition Event.
# Randomization and informed consent are the only two protocol milestones that exist.
# Informed consent is not listed in the dataset anywhere.
ds$DSCAT <- ifelse(ds$DSDECOD == "Randomized",
"Protocol Milestone",
"Disposition Event")
# I included people who had Screen Failures. They are going to have visit numbers of 0.1
# For unscheduled visits, the visit number will have a decimal after it.
# Set VISITNUM's for each visit
ds <- ds %>%
mutate(
VISITNUM = case_when(
DSDECOD == "Randomized" ~ 1,
DSDECOD == "Completed" ~ 2,
DSDECOD == "Final Lab Visit" ~ 3,
DSDECOD == "Final Retrieval Visit" ~ 4,
DSDECOD == "Screen Failure" ~ 0.1,
TRUE ~ 1.1
)
)
# Finally, DSSTDY should be the number of days that pass from the first recorded
# date for each individual USUBJID.
ds <- ds %>%
mutate(DSDTC = as.Date(DSDTC, format = "%m-%d-%Y")) %>%     # ensure Date type
group_by(USUBJID) %>%
mutate(
DSSTDY = as.numeric(DSDTC - min(DSDTC, na.rm = TRUE))
) %>%
ungroup()
# With the new columns, output the final data frame
cleaned_ds <- ds[, c("STUDYID", "DOMAIN", "USUBJID", "DSSEQ", "DSTERM",
"DSDECOD", "DSCAT", "VISITNUM", "VISIT",
"DSDTC", "DSSTDTC", "DSSTDY")]
# But wait! Change the format of DSDTC back to the way it originally was
cleaned_ds <- cleaned_ds %>%
mutate(DSDTC = format(DSDTC, "%m-%d-%Y"))
cleaned_ds
dm <- pharmaversesdtm::dm
ds <- pharmaversesdtm::ds
ex <- pharmaversesdtm::ex
ae <- pharmaversesdtm::ae
lb <- pharmaversesdtm::lb
dm <- convert_blanks_to_na(dm)
ds <- convert_blanks_to_na(ds)
ex <- convert_blanks_to_na(ex)
ae <- convert_blanks_to_na(ae)
lb <- convert_blanks_to_na(lb)
View(dm)
adsl <- dm %>%
select(-DOMAIN)
View(adsl)
View(lb)
adsl <- dm %>%
select(-DOMAIN)
View(adsl)
adsl <- adsl %>%
mutate(
AGEGR9 = case_when(
AGE < 18 ~ "<18",
(AGE >= 18) & (AGE <= 50) ~ "18 - 50",
AGE > 50 ~ ">50"
)
)
View(adsl)
adsl <- adsl %>%
mutate(
AGEGR9 = case_when(
AGE < 18 ~ 1,
(AGE >= 18) & (AGE <= 50) ~ 2,
AGE > 50 ~ 3
)
)
adsl <- adsl %>%
mutate(
AGEGR9 = case_when(
AGE < 18 ~ "<18",
(AGE >= 18) & (AGE <= 50) ~ "18 - 50",
AGE > 50 ~ ">50"
)
)
adsl <- adsl %>%
mutate(
AGEGR9N = case_when(
AGE < 18 ~ 1,
(AGE >= 18) & (AGE <= 50) ~ 2,
AGE > 50 ~ 3
)
)
View(adsl)
View(ex)
ex_valid <- ex %>%
filter(EXDOSE > 0 | (EXDOSE == 0 & grepl("PLACEBO", EXTRT, ignore.case = TRUE)))
x_valid <- ex %>%
filter(EXDOSE > 0 | (EXDOSE == 0 & grepl("PLACEBO", EXTRT, ignore.case = TRUE)))
# Function to impute missing time
impute_time <- function(dt) {
if (is.na(dt)) return(NA)
# If only date is present
if (nchar(dt) == 10) {
return(paste0(dt, " 00:00:00"))
}
# If partially missing time (e.g., "2024-01-01T15" or "2024-01-01T15:30")
# normalize to HH:MM:SS
dt_clean <- dt
if (nchar(dt) == 13) dt_clean <- paste0(dt, ":00:00")
if (nchar(dt) == 16) dt_clean <- paste0(dt, ":00")
# Replace T with space
dt_clean <- gsub("T", " ", dt_clean)
return(dt_clean)
}
ex_valid <- ex_valid %>%
filter(!is.na(substr(EXSTDTC, 1, 10))) %>%  # ensure date part complete
mutate(EXSTDTC_IMPUTED = impute_time(EXSTDTC),
EXSTDTM_NUM = as.POSIXct(EXSTDTC_IMPUTED, format = "%Y-%m-%d %H:%M:%S", tz = "UTC"))
View(ex_valid)
# Vectorized function for EXSTDTC
impute_time <- function(dt) {
# Start with replacing T with space
dt <- gsub("T", " ", dt)
# If completely missing → NA (filter later)
# If only date YYYY-MM-DD → add 00:00:00
dt <- ifelse(nchar(dt) == 10, paste0(dt, " 00:00:00"), dt)
# If partial time
dt <- ifelse(nchar(dt) == 13, paste0(dt, ":00:00"), dt)   # HH
dt <- ifelse(nchar(dt) == 16, paste0(dt, ":00"), dt)      # HH:MM
return(dt)
}
# Apply vectorized function in mutate
ex_valid <- ex_valid %>%
filter(!is.na(substr(EXSTDTC, 1, 10))) %>%  # ensure date part complete
mutate(
EXSTDTC_IMPUTED = impute_time(EXSTDTC),
EXSTDTM_NUM = as.POSIXct(EXSTDTC_IMPUTED, format = "%Y-%m-%d %H:%M:%S", tz = "UTC")
)
View(ex_valid)
# Find first valid exposure per patient
trtsdtm <- ex_valid %>%
group_by(USUBJID) %>%
arrange(EXSTDTM_NUM) %>%
slice_head(n = 1) %>%
ungroup() %>%
select(USUBJID, TRTSDTM = EXSTDTM_NUM)
# Merge with ADSL
adsl <- pharmaversesdtm::dm %>%
left_join(trtsdtm, by = "USUBJID")
dm <- pharmaversesdtm::dm # demographics
ds <- pharmaversesdtm::ds # disposition
ex <- pharmaversesdtm::ex # exposure
ae <- pharmaversesdtm::ae # adverse effects
lb <- pharmaversesdtm::lb # laboratory measurements
dm <- convert_blanks_to_na(dm)
ds <- convert_blanks_to_na(ds)
ex <- convert_blanks_to_na(ex)
ae <- convert_blanks_to_na(ae)
lb <- convert_blanks_to_na(lb)
# DM (demographics) dataset is used as the basis of the ADSL.
adsl <- dm %>%
select(-DOMAIN)
# AGEGR9 variable
adsl <- adsl %>%
mutate(
AGEGR9 = case_when(
AGE < 18 ~ "<18",
(AGE >= 18) & (AGE <= 50) ~ "18 - 50",
AGE > 50 ~ ">50"
)
)
# AGEGR9N variable
adsl <- adsl %>%
mutate(
AGEGR9N = case_when(
AGE < 18 ~ 1,
(AGE >= 18) & (AGE <= 50) ~ 2,
AGE > 50 ~ 3
)
)
# TRTSDTM variable
# First, we filter to valid entries from EX
# ... which is all of them!
ex_valid <- ex %>%
filter(EXDOSE > 0 | (EXDOSE == 0 & grepl("PLACEBO", EXTRT, ignore.case = TRUE)))
# (A valid dose is 0 for a placebo, or above 0 for treaement)
# Function to impute time in EXSTDTC.
impute_time <- function(dt) {
# Start with replacing T with space
dt <- gsub("T", " ", dt)
# If completely missing → NA (filter later)
# If only date YYYY-MM-DD → add 00:00:00
dt <- ifelse(nchar(dt) == 10, paste0(dt, " 00:00:00"), dt)
# If partial time
dt <- ifelse(nchar(dt) == 13, paste0(dt, ":00:00"), dt)   # HH
dt <- ifelse(nchar(dt) == 16, paste0(dt, ":00"), dt)      # HH:MM
return(dt)
}
# Apply vectorized function in mutate
ex_valid <- ex_valid %>%
filter(!is.na(substr(EXSTDTC, 1, 10))) %>%  # ensure date part complete
mutate(
EXSTDTC_IMPUTED = impute_time(EXSTDTC),
EXSTDTM_NUM = as.POSIXct(EXSTDTC_IMPUTED, format = "%Y-%m-%d %H:%M:%S", tz = "UTC")
)
# Find first valid exposure per patient
trtsdtm <- ex_valid %>%
group_by(USUBJID) %>%
arrange(EXSTDTM_NUM) %>%
slice_head(n = 1) %>%
ungroup() %>%
select(USUBJID, TRTSDTM = EXSTDTM_NUM)
# Merge with ADSL
adsl <- adsl %>%
left_join(trtsdtm, by = "USUBJID")
View(adsl)
View(trtsdtm)
adsl$TRTSDTM = ex_valid$EXSTDTC_IMPUTED
View(adsl)
trtsdtm <- ex_valid %>%
group_by(USUBJID) %>%
arrange(EXSTDTM_NUM) %>%
slice_head(n = 1) %>%
ungroup() %>%
select(USUBJID, TRTSDTM = EXSTDTM_IMPUTED)
View(trtsdtm)
ex_valid <- ex_valid %>%
filter(!is.na(substr(EXSTDTC, 1, 10))) %>%  # ensure date part complete
mutate(
EXSTDTC_IMPUTED = impute_time(EXSTDTC),
EXSTDTM_NUM = as.POSIXct(EXSTDTC_IMPUTED, format = "%Y-%m-%d %H:%M:%S", tz = "UTC")
)
View(ex_valid)
trtsdtm <- ex_valid %>%
group_by(USUBJID) %>%
arrange(EXSTDTC_IMPUTED) %>%
slice_head(n = 1) %>%
ungroup() %>%
select(USUBJID, TRTSDTM = EXSTDTM_IMPUTED)
View(trtsdtm)
adsl <- adsl %>%
mutate(
# Convert date (or datetime string) to POSIXct datetime
TRTSDTM = as.POSIXct(TRTSDTM, format = "%Y-%m-%d", tz = "UTC")
)
View(adsl)
dm <- pharmaversesdtm::dm # demographics
ds <- pharmaversesdtm::ds # disposition
ex <- pharmaversesdtm::ex # exposure
ae <- pharmaversesdtm::ae # adverse effects
lb <- pharmaversesdtm::lb # laboratory measurements
dm <- convert_blanks_to_na(dm)
ds <- convert_blanks_to_na(ds)
ex <- convert_blanks_to_na(ex)
ae <- convert_blanks_to_na(ae)
lb <- convert_blanks_to_na(lb)
# DM (demographics) dataset is used as the basis of the ADSL.
adsl <- dm %>%
select(-DOMAIN)
# AGEGR9 variable
adsl <- adsl %>%
mutate(
AGEGR9 = case_when(
AGE < 18 ~ "<18",
(AGE >= 18) & (AGE <= 50) ~ "18 - 50",
AGE > 50 ~ ">50"
)
)
# AGEGR9N variable
adsl <- adsl %>%
mutate(
AGEGR9N = case_when(
AGE < 18 ~ 1,
(AGE >= 18) & (AGE <= 50) ~ 2,
AGE > 50 ~ 3
)
)
# TRTSDTM variable
# First, we filter to valid entries from EX
# ... which is all of them!
ex_valid <- ex %>%
filter(EXDOSE > 0 | (EXDOSE == 0 & grepl("PLACEBO", EXTRT, ignore.case = TRUE)))
# (A valid dose is 0 for a placebo, or above 0 for treaement)
# Function to impute time in EXSTDTC.
impute_time <- function(dt) {
# Start with replacing T with space
dt <- gsub("T", " ", dt)
# If completely missing → NA (filter later)
# If only date YYYY-MM-DD → add 00:00:00
dt <- ifelse(nchar(dt) == 10, paste0(dt, " 00:00:00"), dt)
# If partial time
dt <- ifelse(nchar(dt) == 13, paste0(dt, ":00:00"), dt)   # HH
dt <- ifelse(nchar(dt) == 16, paste0(dt, ":00"), dt)      # HH:MM
return(dt)
}
# Apply vectorized function in mutate
ex_valid <- ex_valid %>%
filter(!is.na(substr(EXSTDTC, 1, 10))) %>%  # ensure date part complete
mutate(
EXSTDTC_IMPUTED = impute_time(EXSTDTC),
EXSTDTM_NUM = as.POSIXct(EXSTDTC_IMPUTED, format = "%Y-%m-%d %H:%M:%S", tz = "UTC")
)
# Find first valid exposure per patient
trtsdtm <- ex_valid %>%
group_by(USUBJID) %>%
arrange(EXSTDTM_NUM) %>%
slice_head(n = 1) %>%
ungroup() %>%
select(USUBJID, TRTSDTM = EXSTDTM_NUM)
# Merge with ADSL
adsl <- adsl %>%
left_join(trtsdtm, by = "USUBJID")
# Convert TRTSDTM to datetime
adsl <- adsl %>%
mutate(
# Convert date (or datetime string) to POSIXct datetime
TRTSDTM = as.POSIXct(TRTSDTM, format = "%Y-%m-%d", tz = "UTC")
)
View(adsl)
adsl <- adsl %>%
mutate(
# Convert date (or datetime string) to POSIXct datetime
TRTSDTM = as.POSIXct(TRTSDTM, format = "%Y-%m-%d %H:%M:%S", tz = "UTC")
)
View(adsl)
adsl <- adsl %>%
mutate(
ITTFL = ifelse(!is.na(ARM), "Y", "N")
)
View(adsl)
dm <- pharmaversesdtm::dm # demographics
ds <- pharmaversesdtm::ds # disposition
ex <- pharmaversesdtm::ex # exposure
ae <- pharmaversesdtm::ae # adverse effects
lb <- pharmaversesdtm::lb # laboratory measurements
vs <- pharmaversesdtm::vs # vitals
dm <- convert_blanks_to_na(dm)
ds <- convert_blanks_to_na(ds)
ex <- convert_blanks_to_na(ex)
ae <- convert_blanks_to_na(ae)
lb <- convert_blanks_to_na(lb)
vs <- convert_blanks_to_na(vs)
vs_last <- vs %>%
filter(
!(is.na(VSSTRESN) & is.na(VSSTRESC)),
!is.na(substr(VSDTC, 1, 10))
) %>%
mutate(VSDT = as.Date(substr(VSDTC, 1, 10))) %>%
group_by(USUBJID) %>%
summarise(VS_LASTDT = max(VSDT, na.rm = TRUE), .groups = "drop")
View(vs_last)
# Vitals last complete date
vs_last <- vs %>%
filter(
!(is.na(VSSTRESN) & is.na(VSSTRESC)),
!is.na(substr(VSDTC, 1, 10))
) %>%
mutate(VSDT = as.Date(substr(VSDTC, 1, 10))) %>%
group_by(USUBJID) %>%
summarise(VS_LASTDT = max(VSDT, na.rm = TRUE), .groups = "drop")
# Adverse effects last onset date
ae_last <- pharmaversesdtm::ae %>%
filter(!is.na(substr(AESTDTC, 1, 10))) %>%
mutate(AEDT = as.Date(substr(AESTDTC, 1, 10))) %>%
group_by(USUBJID) %>%
summarise(AE_LASTDT = max(AEDT, na.rm = TRUE), .groups = "drop")
# Disposition last date
ds_last <- pharmaversesdtm::ds %>%
filter(!is.na(substr(DSSTDTC, 1, 10))) %>%
mutate(DSDT = as.Date(substr(DSSTDTC, 1, 10))) %>%
group_by(USUBJID) %>%
summarise(DS_LASTDT = max(DSDT, na.rm = TRUE), .groups = "drop")
# Treatment last date (from ADSL)
adsl <- adsl %>%
mutate(TRT_LASTDT = as.Date(TRTEDTM))
View(adsl)
vs_last <- vs %>%
filter(
!(is.na(VSSTRESN) & is.na(VSSTRESC)),
!is.na(substr(VSDTC, 1, 10))
) %>%
mutate(VSDT = as.Date(substr(VSDTC, 1, 10))) %>%
group_by(USUBJID) %>%
summarise(VS_LASTDT = max(VSDT, na.rm = TRUE), .groups = "drop")
# Adverse effects last onset date
ae_last <- pharmaversesdtm::ae %>%
filter(!is.na(substr(AESTDTC, 1, 10))) %>%
mutate(AEDT = as.Date(substr(AESTDTC, 1, 10))) %>%
group_by(USUBJID) %>%
summarise(AE_LASTDT = max(AEDT, na.rm = TRUE), .groups = "drop")
# Disposition last date
ds_last <- pharmaversesdtm::ds %>%
filter(!is.na(substr(DSSTDTC, 1, 10))) %>%
mutate(DSDT = as.Date(substr(DSSTDTC, 1, 10))) %>%
group_by(USUBJID) %>%
summarise(DS_LASTDT = max(DSDT, na.rm = TRUE), .groups = "drop")
# Treatment last date (from ADSL)
adsl <- adsl %>%
mutate(TRT_LASTDT = as.Date(TRTSDTM))
# Combine everything and derive LSTAVLDT
adsl <- adsl %>%
left_join(vs_last, by = "USUBJID") %>%
left_join(ae_last, by = "USUBJID") %>%
left_join(ds_last, by = "USUBJID") %>%
mutate(
LSTAVLDT = pmax(
VS_LASTDT,
AE_LASTDT,
DS_LASTDT,
TRT_LASTDT,
na.rm = TRUE
)
)
View(adsl)
adsl <- adsl %>%
select(-TRT_LASTDT, -VS_LASTDT, -AE_LASTDT, -DS_LASTDT)
